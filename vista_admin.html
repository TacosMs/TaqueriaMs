<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Gerente - Taquería MS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --primary: #d97706;
            --secondary: #f59e0b;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a1a;
            color: white;
        }
        
        .stats-card {
            background: linear-gradient(145deg, #2d2d2d, #252525);
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .best-seller-card {
            background: linear-gradient(145deg, #2d2d2d, #252525);
            border-radius: 12px;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .best-seller-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn {
            color: #777;
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            color: var(--primary);
        }
        
        .nav-btn.active svg, .nav-btn.active i { /* Añadido 'i' para FontAwesome */
            fill: var(--primary);
            color: var(--primary); /* Para FontAwesome */
        }
        
        .chart-container {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .timeframe-btn {
            background: #3d3d3d;
            color: #aaa;
            transition: all 0.3s;
        }
        
        .timeframe-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(217, 119, 6, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0); }
        }
        
        .floating { animation: floating 3s ease-in-out infinite; }
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .glow-on-hover { transition: all 0.3s ease; }
        .glow-on-hover:hover { box-shadow: 0 0 15px rgba(217, 119, 6, 0.5); }
        
        @media (min-width: 768px) { /* md */
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .flex-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1024px) { /* lg */
            .stats-grid { grid-template-columns: repeat(3, 1fr); } 
            .flex-grid { grid-template-columns: repeat(3, 1fr); }
        }
         @media (min-width: 1280px) { /* xl */
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <div class="bg-black py-4 px-6 flex justify-between items-center sticky top-0 z-20"> 
        <h1 class="text-xl font-bold text-amber-500">Taquería MS - Vista Gerente</h1>
        <div class="flex items-center space-x-4">
            <span class="text-sm bg-amber-600 px-3 py-1 rounded-full" id="current-date"></span>
            <button id="logoutButton" title="Cerrar Sesión" class="text-white hover:text-red-500 transition-colors duration-150">
                <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
        </div>
    </div>

    <div id="mainContent" class="px-4 py-3 opacity-0 transition-opacity duration-500"> 
        <div class="flex overflow-x-auto whitespace-nowrap space-x-2 mb-6 pb-2">
            <button class="timeframe-btn px-4 py-2 rounded-full font-medium active" data-timeframe="hoy">Hoy</button>
            <button class="timeframe-btn px-4 py-2 rounded-full font-medium" data-timeframe="semana">Esta Semana</button>
            <button class="timeframe-btn px-4 py-2 rounded-full font-medium" data-timeframe="mes">Este Mes</button>
            <button class="timeframe-btn px-4 py-2 rounded-full font-medium" data-timeframe="año">Este Año</button>
            <button class="timeframe-btn px-4 py-2 rounded-full font-medium" data-timeframe="personalizado">Personalizado</button>
        </div>
        
        <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-chart-line text-amber-500 mr-2"></i> Resumen General
        </h2>
        <div class="grid grid-cols-1 gap-4 mb-6 stats-grid">
            <div class="stats-card p-5 glow-on-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm">Ventas Totales</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-sales">$0</h3>
                        <p class="text-green-400 text-sm mt-2 flex items-center" id="sales-change">
                            <i class="fas fa-caret-up mr-1"></i> 0%
                        </p>
                    </div>
                    <div class="bg-amber-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-dollar-sign text-amber-500 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-5 glow-on-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm">Ventas en Efectivo</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-cash-sales">$0</h3>
                        <p class="text-green-400 text-sm mt-2 flex items-center" id="cash-sales-change">
                            <i class="fas fa-caret-up mr-1"></i> 0% 
                        </p>
                    </div>
                    <div class="bg-emerald-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-money-bill-wave text-emerald-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stats-card p-5 glow-on-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm">Ventas con Tarjeta</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-card-sales">$0</h3>
                        <p class="text-green-400 text-sm mt-2 flex items-center" id="card-sales-change">
                             <i class="fas fa-caret-up mr-1"></i> 0%
                        </p>
                    </div>
                    <div class="bg-sky-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-credit-card text-sky-500 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-5 glow-on-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm">Órdenes Totales</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-orders">0</h3>
                        <p class="text-green-400 text-sm mt-2 flex items-center" id="orders-change">
                            <i class="fas fa-caret-up mr-1"></i> 0%
                        </p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-clipboard-list text-blue-500 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-5 glow-on-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm">Productos Vendidos</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-products">0</h3>
                        <p class="text-green-400 text-sm mt-2 flex items-center" id="products-change">
                            <i class="fas fa-caret-up mr-1"></i> 0%
                        </p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-utensils text-green-500 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card p-5 glow-on-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm">Ticket Promedio</p>
                        <h3 class="text-2xl font-bold mt-1" id="average-ticket">$0</h3>
                        <p class="text-green-400 text-sm mt-2 flex items-center" id="ticket-change">
                            <i class="fas fa-caret-up mr-1"></i> 0%
                        </p>
                    </div>
                    <div class="bg-purple-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-receipt text-purple-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-chart-bar text-amber-500 mr-2"></i> Tendencia de Ventas
        </h2>
        <div class="chart-container mb-6 glow-on-hover">
            <canvas id="salesChart"></canvas>
        </div>

        <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-pie-chart text-amber-500 mr-2"></i> Distribución de Métodos de Pago
        </h2>
        <div class="chart-container mb-6 glow-on-hover">
            <canvas id="paymentMethodDistributionChart"></canvas>
        </div>
        
        <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-chair text-amber-500 mr-2"></i> Órdenes por Mesa
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6 flex-grid" id="orders-by-table-cards">
        </div>

        <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-table text-amber-500 mr-2"></i> Desempeño por Mesa (Detalle)
        </h2>
        <div class="bg-gray-800 rounded-lg overflow-hidden mb-6 glow-on-hover">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-700 text-left">
                            <th class="py-3 px-4">Mesa</th>
                            <th class="py-3 px-4">Órdenes</th>
                            <th class="py-3 px-4">Ventas</th>
                            <th class="py-3 px-4">Promedio</th>
                            <th class="py-3 px-4">% Total</th>
                        </tr>
                    </thead>
                    <tbody id="tables-performance">
                    </tbody>
                </table>
            </div>
        </div>
        
        <h2 class="text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-clock text-amber-500 mr-2"></i> Horario Pico
        </h2>
        <div class="chart-container mb-6 glow-on-hover">
            <canvas id="peakHoursChart"></canvas>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-gray-800 flex justify-around py-3 z-10"> 
        <button class="nav-btn flex flex-col items-center active" data-tab="dashboard"> 
            <i class="fas fa-chart-pie text-xl mb-1"></i>
            <span class="text-xs">Dashboard</span>
        </button>
        <a href="inventario.html" class="nav-btn flex flex-col items-center" data-tab="inventory">
            <i class="fas fa-boxes text-xl mb-1"></i>
            <span class="text-xs">Inventario</span>
        </a>
    </div>

    <div id="date-range-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Seleccionar Rango de Fechas</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Fecha Inicio</label>
                    <input type="date" id="start-date" class="w-full bg-gray-700 rounded-lg p-2 text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Fecha Fin</label>
                    <input type="date" id="end-date" class="w-full bg-gray-700 rounded-lg p-2 text-white">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-date-range" class="bg-gray-700 text-white px-4 py-2 rounded-lg">Cancelar</button>
                <button id="apply-date-range" class="bg-amber-600 text-white px-4 py-2 rounded-lg">Aplicar</button>
            </div>
        </div>
    </div>

<script>
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDi4WBHRGgXMp_rtPvV9IDw3foEjtr0L2o",
        authDomain: "tacosms-acbb2.firebaseapp.com",
        databaseURL: "https://tacosms-acbb2-default-rtdb.firebaseio.com",
        projectId: "tacosms-acbb2",
        storageBucket: "tacosms-acbb2.appspot.com",
        messagingSenderId: "701143542092",
        appId: "1:701143542092:web:29f1d59ffe2751a3c207e9"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();
    const auth = firebase.auth(); 

    const mainContent = document.getElementById('mainContent');

    auth.onAuthStateChanged(user => {
        if (user) {
            database.ref('/userRoles/' + user.uid + '/role').once('value').then(snapshot => {
                const role = snapshot.val();
                if (role === 'gerente') {
                    mainContent.classList.remove('opacity-0'); 
                    initializeDashboard(); 
                } else {
                    alert("No tienes permiso para acceder a esta página.");
                    auth.signOut().then(() => { window.location.href = 'login.html'; });
                }
            }).catch(error => {
                alert("Error al verificar tu rol. Se cerrará la sesión.");
                auth.signOut().then(() => { window.location.href = 'login.html'; });
            });
        } else {
            window.location.href = 'login.html';
        }
    });

    const logoutButton = document.getElementById('logoutButton');
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                alert("Has cerrado sesión.");
                window.location.href = 'login.html';
            }).catch((error) => {
                alert("Error al cerrar sesión: " + error.message);
            });
        });
    }
    
    let salesChart, peakHoursChart, paymentMethodDistributionChart; 
    
    const appState = {
        currentTimeframe: 'hoy',
        startDate: null,
        endDate: null,
        ordersData: [],
        previousData: [],
        ordersByIndividualTable: {}
    };

    function formatMoney(amount) {
        return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function formatDate(date) {
        const offset = date.getTimezoneOffset(); 
        const localDate = new Date(date.getTime() - (offset * 60 * 1000));
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return localDate.toLocaleDateString('es-MX', options);
    }

    function updateCurrentDate() {
        const el = document.getElementById('current-date');
        if(el) el.textContent = formatDate(new Date());
    }

    function getDateRange(timeframe) {
        const now = new Date();
        let start, end = new Date(now);
        now.setHours(0, 0, 0, 0); 

        switch(timeframe) {
            case 'hoy':
                start = new Date(now);
                end = new Date(now); 
                end.setHours(23, 59, 59, 999);
                break;
            case 'semana':
                start = new Date(now);
                start.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)); 
                start.setHours(0, 0, 0, 0);
                end = new Date(start);
                end.setDate(start.getDate() + 6); 
                end.setHours(23, 59, 59, 999);
                break;
            case 'mes':
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0); 
                end.setHours(23, 59, 59, 999);
                break;
            case 'año':
                start = new Date(now.getFullYear(), 0, 1);
                end = new Date(now.getFullYear(), 11, 31);
                end.setHours(23, 59, 59, 999);
                break;
            case 'personalizado':
                if (!appState.startDate || !appState.endDate) { 
                    console.warn("Fechas personalizadas no establecidas, usando 'hoy' por defecto.");
                    return getDateRange('hoy'); 
                }
                const customStart = new Date(appState.startDate);
                customStart.setHours(0, 0, 0, 0);
                const customEnd = new Date(appState.endDate);
                customEnd.setHours(23, 59, 59, 999);
                return { start: customStart, end: customEnd };
            default:
                start = new Date(now);
                start.setHours(0, 0, 0, 0);
                end = new Date(now);
                end.setHours(23, 59, 59, 999);
        }
        return { start, end };
    }

    async function loadData(timeframe) {
        // Diagnostic log: Indicate which timeframe is being loaded
        console.log(`[AdminView] Iniciando carga de datos para el período: ${timeframe}`);
        const { start, end } = getDateRange(timeframe);
         // Diagnostic log: Show the actual date range being used
        console.log(`[AdminView] Rango de fechas calculado: INICIO=${start.toISOString()} FIN=${end.toISOString()}`);
        appState.currentTimeframe = timeframe;
        
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.timeframe === timeframe) btn.classList.add('active');
        });
        
        showLoading();
        
        try {
            const currentData = await fetchOrdersData(start, end);
            appState.ordersData = currentData;
            // Diagnostic log: How many orders were fetched for the current period
            console.log(`[AdminView] Órdenes obtenidas para el período actual (${timeframe}): ${appState.ordersData.length}`);
            
            let previousStart, previousEnd;
             if (timeframe === 'hoy') {
                previousStart = new Date(start); previousStart.setDate(start.getDate() - 1);
                previousEnd = new Date(end); previousEnd.setDate(end.getDate() - 1);
            } else if (timeframe === 'semana') {
                previousStart = new Date(start); previousStart.setDate(start.getDate() - 7);
                previousEnd = new Date(end); previousEnd.setDate(end.getDate() - 7);
            } else if (timeframe === 'mes') {
                previousStart = new Date(start.getFullYear(), start.getMonth() - 1, 1);
                previousEnd = new Date(start.getFullYear(), start.getMonth(), 0); 
            } else if (timeframe === 'año') {
                previousStart = new Date(start.getFullYear() - 1, 0, 1);
                previousEnd = new Date(start.getFullYear() - 1, 11, 31);
            }
            
            if (timeframe !== 'personalizado' && previousStart && previousEnd) { 
                // Diagnostic log: Show the date range for the previous period
                console.log(`[AdminView] Calculando período anterior: INICIO=${previousStart.toISOString()} FIN=${previousEnd.toISOString()}`);
                const previousData = await fetchOrdersData(previousStart, previousEnd);
                appState.previousData = previousData;
                // Diagnostic log: How many orders for the previous period
                console.log(`[AdminView] Órdenes obtenidas para el período anterior: ${appState.previousData.length}`);
            } else {
                appState.previousData = [];
            }
            processDataAndUpdateUI();
        } catch (error) {
            console.error('[AdminView] Error al cargar datos:', error);
        } finally {
            hideLoading();
        }
    }

    async function fetchOrdersData(startDate, endDate) {
        if (!(startDate instanceof Date) || !(endDate instanceof Date) || isNaN(startDate) || isNaN(endDate)) {
            console.error("[AdminView] fetchOrdersData recibió fechas inválidas:", startDate, endDate);
            return []; 
        }
        const startStr = startDate.toISOString().split('T')[0];
        const endStr = endDate.toISOString().split('T')[0];
        
        const snapshot = await database.ref('orders').orderByKey().startAt(startStr).endAt(endStr).once('value');
        const ordersData = snapshot.val();
        const filteredOrders = [];
        
        if (ordersData) {
            console.log("[AdminView] Datos crudos de Firebase:", ordersData); // DIAGNÓSTICO: Ver estructura cruda
            for (const dateKey in ordersData) {
                const ordersForDate = ordersData[dateKey];
                for (const orderId in ordersForDate) {
                    const order = ordersForDate[orderId];
                    // --- INICIO DIAGNÓSTICO DETALLADO POR ORDEN ---
                    console.log(`[AdminView] Orden obtenida de Firebase (ID: ${orderId}, Fecha: ${dateKey}): paymentMethod='${order.paymentMethod}', total=${order.total}`); 
                    // --- FIN DIAGNÓSTICO DETALLADO POR ORDEN ---

                    if (order.items && typeof order.items === 'object' && !Array.isArray(order.items)) {
                        order.items = Object.values(order.items);
                    } else if (!order.items) {
                        order.items = []; 
                    }
                    // Si paymentMethod es undefined o null, se asigna "No especificado"
                    if (order.paymentMethod === undefined || order.paymentMethod === null) {
                        console.warn(`[AdminView] Orden ID ${orderId} en fecha ${dateKey} NO tiene paymentMethod o es null. Se asigna "No especificado".`);
                        order.paymentMethod = "No especificado"; 
                    } else if (typeof order.paymentMethod !== 'string' || order.paymentMethod.trim() === '') {
                         console.warn(`[AdminView] Orden ID ${orderId} en fecha ${dateKey} tiene paymentMethod inválido ('${order.paymentMethod}'). Se asigna "No especificado".`);
                        order.paymentMethod = "No especificado";
                    }
                    filteredOrders.push({ ...order, date: dateKey, orderId: orderId });
                }
            }
        } else {
            console.log("[AdminView] No se encontraron órdenes en Firebase para el rango especificado.");
        }
        return filteredOrders;
    }

    function processDataAndUpdateUI() {
        const orders = appState.ordersData;
        const previousOrders = appState.previousData;
        
        let totalSales = 0, totalCashSales = 0, totalCardSales = 0, totalOtherPaymentSales = 0;
        let totalOrders = orders.length;
        let totalProducts = 0;

        console.log("[AdminView] --- Iniciando procesamiento de datos para UI ---");
        orders.forEach(order => {
            const orderTotal = order.total || 0;
            totalSales += orderTotal;
            
            // --- INICIO DIAGNÓSTICO DENTRO DEL BUCLE DE PROCESAMIENTO ---
            console.log(`[AdminView] Procesando orden para UI: paymentMethod='${order.paymentMethod}', Total=${orderTotal}`); 
            // --- FIN DIAGNÓSTICO DENTRO DEL BUCLE DE PROCESAMIENTO ---
            
            // Asegurarse que la comparación sea exacta y sensible a mayúsculas/minúsculas
            if (order.paymentMethod === 'Efectivo') {
                totalCashSales += orderTotal;
            } else if (order.paymentMethod === 'Tarjeta') {
                totalCardSales += orderTotal;
            } else {
                totalOtherPaymentSales += orderTotal; 
                if (order.paymentMethod !== "No especificado") { // Solo advertir si no es el default que asignamos
                    console.warn(`[AdminView] Método de pago no reconocido o no especificado: '${order.paymentMethod}' para orden con total ${orderTotal}. Sumado a 'Otros'.`);
                }
            }

            if (order.items && Array.isArray(order.items)) {
                totalProducts += order.items.reduce((sum, item) => sum + (item.quantity || 1), 0); 
            }
        });
        // --- INICIO DIAGNÓSTICO DE TOTALES FINALES ---
        console.log(`[AdminView] Totales finales calculados: General=${formatMoney(totalSales)}, Efectivo=${formatMoney(totalCashSales)}, Tarjeta=${formatMoney(totalCardSales)}, Otro=${formatMoney(totalOtherPaymentSales)}`);
        // --- FIN DIAGNÓSTICO DE TOTALES FINALES ---

        const averageTicket = totalOrders > 0 ? totalSales / totalOrders : 0;
        
        let previousTotalSales = 0, previousTotalOrders = 0, previousTotalProducts = 0, previousAverageTicket = 0;
        let previousTotalCashSales = 0, previousTotalCardSales = 0; 

        if (previousOrders.length > 0) {
            previousOrders.forEach(order => {
                const prevOrderTotal = order.total || 0;
                previousTotalSales += prevOrderTotal;
                if (order.paymentMethod === 'Efectivo') {
                    previousTotalCashSales += prevOrderTotal;
                } else if (order.paymentMethod === 'Tarjeta') {
                    previousTotalCardSales += prevOrderTotal;
                }
                if (order.items && Array.isArray(order.items)) {
                     previousTotalProducts += order.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
                }
            });
            previousTotalOrders = previousOrders.length;
            previousAverageTicket = previousTotalOrders > 0 ? previousTotalSales / previousTotalOrders : 0;
        }
        
        const salesChange = previousTotalSales > 0 ? ((totalSales - previousTotalSales) / previousTotalSales * 100) : (totalSales > 0 ? 100 : 0);
        const ordersChange = previousTotalOrders > 0 ? ((totalOrders - previousTotalOrders) / previousTotalOrders * 100) : (totalOrders > 0 ? 100 : 0);
        const productsChange = previousTotalProducts > 0 ? ((totalProducts - previousTotalProducts) / previousTotalProducts * 100) : (totalProducts > 0 ? 100 : 0);
        const ticketChange = previousAverageTicket > 0 ? ((averageTicket - previousAverageTicket) / previousAverageTicket * 100) : (averageTicket > 0 ? 100 : 0);
        const cashSalesChange = previousTotalCashSales > 0 ? ((totalCashSales - previousTotalCashSales) / previousTotalCashSales * 100) : (totalCashSales > 0 ? 100 : 0);
        const cardSalesChange = previousTotalCardSales > 0 ? ((totalCardSales - previousTotalCardSales) / previousTotalCardSales * 100) : (totalCardSales > 0 ? 100 : 0);
                
        document.getElementById('total-sales').textContent = formatMoney(totalSales);
        document.getElementById('total-cash-sales').textContent = formatMoney(totalCashSales); 
        document.getElementById('total-card-sales').textContent = formatMoney(totalCardSales); 
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('total-products').textContent = totalProducts;
        document.getElementById('average-ticket').textContent = formatMoney(averageTicket);
        
        updateChangeIndicator('sales-change', salesChange.toFixed(1));
        updateChangeIndicator('cash-sales-change', cashSalesChange.toFixed(1)); 
        updateChangeIndicator('card-sales-change', cardSalesChange.toFixed(1)); 
        updateChangeIndicator('orders-change', ordersChange.toFixed(1));
        updateChangeIndicator('products-change', productsChange.toFixed(1));
        updateChangeIndicator('ticket-change', ticketChange.toFixed(1));
        
        processOrdersByIndividualTable(orders); 
        processChartData(orders); 
        processTablesPerformance(orders, totalSales);
        updatePaymentMethodDistributionChart(totalCashSales, totalCardSales, totalOtherPaymentSales); 
        console.log("[AdminView] --- UI Actualizada ---");
    }

    function updateChangeIndicator(elementId, changePercent) {
        const element = document.getElementById(elementId);
        if (!element) return;
        const change = parseFloat(changePercent);
        let iconClass = 'fa-equals'; let colorClass = 'text-gray-400';
        if (change > 0) { iconClass = 'fa-caret-up'; colorClass = 'text-green-400'; }
        else if (change < 0) { iconClass = 'fa-caret-down'; colorClass = 'text-red-400'; }
        element.innerHTML = `<i class="fas ${iconClass} mr-1"></i> ${Math.abs(change).toFixed(1)}%`; 
        element.className = `${colorClass} text-sm mt-2 flex items-center`;
    }

    function processOrdersByIndividualTable(orders) {
        appState.ordersByIndividualTable = {};
        orders.forEach(order => {
            const table = order.table || 'Takeout'; 
            if (!appState.ordersByIndividualTable[table]) {
                appState.ordersByIndividualTable[table] = 0;
            }
            appState.ordersByIndividualTable[table]++;
        });
        updateOrdersByIndividualTableUI(appState.ordersByIndividualTable);
    }

    function updateOrdersByIndividualTableUI(data) {
        const container = document.getElementById('orders-by-table-cards');
        if(!container) return;
        container.innerHTML = ''; 
        const sortedTables = Object.keys(data).sort((a, b) => data[b] - data[a]); 
        sortedTables.forEach(table => {
            const card = document.createElement('div');
            card.className = 'stats-card p-4 glow-on-hover';
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-400 text-sm">Mesa #${table}</p>
                        <h3 class="text-2xl font-bold mt-1">${data[table]}</h3>
                        <p class="text-gray-400 text-sm">órdenes</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-chair text-blue-500 text-xl"></i>
                    </div>
                </div>`;
            container.appendChild(card);
        });
        if (sortedTables.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center col-span-full py-4">No hay órdenes por mesa en este período.</p>';
        }
    }

    function processChartData(orders) {
        const salesByDay = {}; const ordersByHour = Array(24).fill(0);
        orders.forEach(order => {
            const orderDateVal = order.date.includes('T') ? order.date.split('T')[0] : order.date; 
            const orderDate = new Date(orderDateVal + 'T00:00:00'); 
            const dayKey = orderDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' }); 
            if (!salesByDay[dayKey]) salesByDay[dayKey] = 0;
            salesByDay[dayKey] += (order.total || 0);
            const timestamp = order.timestamp;
            if (timestamp) {
                const orderTime = new Date(timestamp);
                ordersByHour[orderTime.getHours()]++;
            }
        });
        updateSalesChart(Object.keys(salesByDay), Object.values(salesByDay));
        updatePeakHoursChart(ordersByHour);
    }

    function updateSalesChart(labels, data) {
        const ctx = document.getElementById('salesChart')?.getContext('2d');
        if (!ctx) return;
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Ventas', data, backgroundColor: 'rgba(217, 119, 6, 0.7)', borderColor: 'rgba(217, 119, 6, 1)', borderWidth: 1, borderRadius: 4 }] },
            options: { responsive: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => formatMoney(c.raw) }}}, scales: { y: { beginAtZero: true, ticks: { callback: v => formatMoney(v), color: '#9ca3af' }}, x: { ticks: { color: '#9ca3af' }} } }
        });
    }

    function updatePeakHoursChart(data) {
        const ctx = document.getElementById('peakHoursChart')?.getContext('2d');
        if (!ctx) return;
        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
        if (peakHoursChart) peakHoursChart.destroy();
        peakHoursChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Órdenes por hora', data, backgroundColor: 'rgba(217, 119, 6, 0.2)', borderColor: 'rgba(217, 119, 6, 1)', borderWidth: 2, tension: 0.4, fill: true }] },
            options: { responsive: true, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true, ticks: { precision: 0, color: '#9ca3af' }}, x: { ticks: { color: '#9ca3af' }} }}
        });
    }

    function updatePaymentMethodDistributionChart(cashSales, cardSales, otherSales = 0) {
        const ctx = document.getElementById('paymentMethodDistributionChart')?.getContext('2d');
        if (!ctx) return;

        const total = cashSales + cardSales + otherSales;
        
        if (paymentMethodDistributionChart) {
            paymentMethodDistributionChart.destroy();
        }

        if (total === 0) { 
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = "16px Poppins";
            ctx.fillStyle = "#777";
            ctx.textAlign = "center";
            ctx.fillText("No hay datos de métodos de pago.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const dataValues = [cashSales, cardSales];
        const labels = ['Efectivo', 'Tarjeta'];
        const backgroundColors = ['rgba(16, 185, 129, 0.7)', 'rgba(14, 165, 233, 0.7)']; 
        const borderColors = ['rgba(16, 185, 129, 1)', 'rgba(14, 165, 233, 1)'];

        if (otherSales > 0) {
            labels.push('Otro/No Esp.');
            dataValues.push(otherSales);
            backgroundColors.push('rgba(107, 114, 128, 0.7)');
            borderColors.push('rgba(107, 114, 128, 1)');
        }

        paymentMethodDistributionChart = new Chart(ctx, {
            type: 'pie',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: dataValues, 
                    backgroundColor: backgroundColors, 
                    borderColor: borderColors, 
                    borderWidth: 1 
                }] 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { color: 'white' }},
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) label += ': ';
                                if (context.parsed !== null) {
                                    label += formatMoney(context.parsed);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    label += ` (${percentage}%)`;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function processTablesPerformance(orders, totalSales) {
        const tablesData = {};
        orders.forEach(order => {
            const table = order.table || 'Takeout';
            if (!tablesData[table]) tablesData[table] = { orders: 0, sales: 0 };
            tablesData[table].orders++;
            tablesData[table].sales += (order.total || 0); 
        });
        const tablesArray = Object.keys(tablesData).map(table => {
            const d = tablesData[table]; const avg = d.orders > 0 ? d.sales / d.orders : 0;
            return { table, orders: d.orders, sales: d.sales, average: avg, percentage: totalSales > 0 ? (d.sales / totalSales * 100) : 0 };
        });
        tablesArray.sort((a, b) => b.sales - a.sales);
        updateTablesPerformanceUI(tablesArray);
    }

    function updateTablesPerformanceUI(tablesData) {
        const tbody = document.getElementById('tables-performance');
        if(!tbody) return;
        tbody.innerHTML = '';
        if (tablesData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400 py-4">No hay datos de desempeño por mesa.</td></tr>';
            return;
        }
        tablesData.forEach(data => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700 hover:bg-gray-700';
            row.innerHTML = `
                <td class="py-3 px-4 font-medium">${data.table}</td> <td class="py-3 px-4">${data.orders}</td>
                <td class="py-3 px-4">${formatMoney(data.sales)}</td> <td class="py-3 px-4">${formatMoney(data.average)}</td>
                <td class="py-3 px-4">
                    <div class="w-full bg-gray-600 rounded-full h-2"><div class="bg-amber-500 h-2 rounded-full" style="width: ${data.percentage.toFixed(1)}%"></div></div>
                    <span class="text-xs">${data.percentage.toFixed(1)}%</span>
                </td>`;
            tbody.appendChild(row);
        });
    }

    function showLoading() { /* Implementar si es necesario */ }
    function hideLoading() { /* Implementar si es necesario */ }

    function initializeDashboard() {
        updateCurrentDate();
        loadData('hoy'); 
        
        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const timeframe = btn.dataset.timeframe;
                if (timeframe === 'personalizado') {
                    document.getElementById('date-range-modal').classList.remove('hidden');
                } else {
                    loadData(timeframe);
                }
            });
        });
        
        const cancelDateRangeBtn = document.getElementById('cancel-date-range');
        if (cancelDateRangeBtn) {
            cancelDateRangeBtn.addEventListener('click', () => {
                document.getElementById('date-range-modal').classList.add('hidden');
            });
        }
        
        const applyDateRangeBtn = document.getElementById('apply-date-range');
        if (applyDateRangeBtn) {
            applyDateRangeBtn.addEventListener('click', () => {
                const startDateInput = document.getElementById('start-date').value;
                const endDateInput = document.getElementById('end-date').value;
                if (startDateInput && endDateInput) {
                    appState.startDate = new Date(startDateInput + 'T00:00:00'); 
                    appState.endDate = new Date(endDateInput + 'T23:59:59');   
                    if (appState.startDate > appState.endDate) {
                        alert('La fecha de inicio no puede ser posterior a la fecha de fin.'); return;
                    }
                    appState.currentTimeframe = 'personalizado';
                    document.getElementById('date-range-modal').classList.add('hidden');
                    loadData('personalizado');
                } else {
                    alert('Por favor seleccione ambas fechas');
                }
            });
        }
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                event.currentTarget.classList.add('active');
            });
        });
    }
</script>
</body>
</html>